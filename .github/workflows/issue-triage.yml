name: Issue Triage Automation

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Apply default triage labels
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue = context.payload.issue;

            if (issue.pull_request) return;

            const title = issue.title || "";
            const existing = new Set((issue.labels || []).map(l => l.name));

            const add = (name) => { if (!existing.has(name)) existing.add(name); };

            // Always require triage for new issues
            add("status: needs-triage");

            // Default priority if none exists
            const hasPriority = Array.from(existing).some(l => l.startsWith("priority: "));
            if (!hasPriority) add("priority: p2");

            // Route by title prefix (works even if someone bypasses templates)
            if (title.startsWith("[MODEL]")) add("modeling");
            if (title.startsWith("[GFET]")) add("electronics");
            if (title.startsWith("[ANALYSIS]")) add("analysis");
            if (title.startsWith("[DOC]")) add("documentation");

            await github.rest.issues.update({
              owner, repo,
              issue_number: issue.number,
              labels: Array.from(existing)
            });