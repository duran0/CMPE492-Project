name: Auto-assign milestone from Issue Form

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  issues: write

jobs:
  assign_milestone:
    runs-on: ubuntu-latest
    steps:
      - name: Assign milestone based on "Target Milestone"
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue = context.payload.issue;

            // Only handle issues (not PRs)
            if (issue.pull_request) {
              core.info("Skipping PR.");
              return;
            }

            const body = issue.body || "";

            // Issue Forms render as:
            // ### Target Milestone
            // <selected option>
            const match = body.match(/###\s*Target Milestone\s*\n+([^\n\r]+)/i);
            if (!match) {
              core.warning("No 'Target Milestone' found in issue body. Skipping.");
              return;
            }

            const selected = match[1].trim();
            core.info(`Selected milestone option: ${selected}`);

            // Map selection -> actual GitHub milestone title (must exist)
            const milestoneTitle = selected; // same string as milestone title
            // If you ever want different display text vs milestone title, replace above with a map.

            // Fetch open milestones, find the matching one
            const milestones = await github.paginate(
              github.rest.issues.listMilestones,
              { owner, repo, state: "open", per_page: 100 }
            );

            const m = milestones.find(ms => (ms.title || "").trim() === milestoneTitle);
            if (!m) {
              core.setFailed(`Milestone not found: "${milestoneTitle}". Create it in GitHub first.`);
              return;
            }

            // Update issue milestone (by number)
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issue.number,
              milestone: m.number
            });

            core.info(`Assigned issue #${issue.number} -> milestone "${m.title}" (number ${m.number})`);